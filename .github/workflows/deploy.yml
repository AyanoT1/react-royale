name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  SERVICE_NAME: react-royale
  MONGODB_SERVICE_NAME: react-royale-mongodb

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify Service Account Permissions
        run: |
          echo "Verifying service account has necessary permissions..."
          gcloud projects get-iam-policy ${{ env.PROJECT_ID }} --flatten="bindings[].members" --filter="bindings.members:serviceAccount:*" --format="table(bindings.role)" || true

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build Application Image
        run: |
          docker build \
            --build-arg VITE_BASE_PATH=${{ secrets.VITE_BASE_PATH || '/' }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/react-royale/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/react-royale/${{ env.SERVICE_NAME }}:latest \
            -f Dockerfile .

      - name: Create Artifact Registry Repository (if not exists)
        continue-on-error: true
        run: |
          gcloud artifacts repositories create react-royale \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Docker repository for React Royale"

      - name: Push Application Image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/react-royale/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/react-royale/${{ env.SERVICE_NAME }}:latest

      - name: Deploy Application to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/react-royale/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --platform=managed \
            --region=${{ env.REGION }} \
            --allow-unauthenticated \
            --port=7137 \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="HOST=0.0.0.0" \
            --set-env-vars="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars="MONGODB_URI=${{ secrets.MONGODB_URI }}" \
            --set-env-vars="MONGODB_DBNAME=${{ secrets.MONGODB_DBNAME || 'db' }}" \
            --cpu=1 \
            --memory=512Mi \
            --min-instances=0 \
            --max-instances=10 \
            --execution-environment=gen2

      - name: Set Public Access IAM Policy
        run: |
          gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker"

      - name: Get Service URL and Update Environment Variables
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Application deployed at: $SERVICE_URL"

          # Update service with correct CORS and frontend URL
          gcloud run services update ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --set-env-vars="FRONTEND_URL=$SERVICE_URL" \
            --set-env-vars="CORS_ORIGINS=$SERVICE_URL"

          echo "Environment variables updated with service URL"

      - name: Verify Service Health
        run: |
          echo "Checking service status..."
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="yaml(status.conditions)"

          echo ""
          echo "Checking recent logs..."
          gcloud logs read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
            --limit=50 \
            --format="table(timestamp,severity,textPayload)" \
            --project=${{ env.PROJECT_ID }} || echo "Logs not available yet"

          echo ""
          echo "Testing public access..."
          SERVICE_URL="${{ steps.get-url.outputs.SERVICE_URL }}"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL" || echo "000")
          echo "HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" = "000" ]; then
            echo "⚠️ Warning: Could not reach service"
          elif [ "$HTTP_STATUS" = "403" ]; then
            echo "⚠️ Warning: Access forbidden - IAM policy may not be applied yet"
          elif [ "$HTTP_STATUS" -ge "200" ] && [ "$HTTP_STATUS" -lt "400" ]; then
            echo "✓ Service is publicly accessible"
          else
            echo "⚠️ Warning: Service returned status $HTTP_STATUS"
          fi

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Project ID**: ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Name**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL**: ${{ steps.get-url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access your application at:** ${{ steps.get-url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
